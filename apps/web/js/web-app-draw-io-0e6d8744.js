define(["./chunks/vendor-e2ecbc23","./chunks/useClientService-0039200a","./chunks/useAppDefaults-5dde407f","./chunks/functions-31457630","./chunks/useRoute-035af8cd","./chunks/useRequest-915f01e1"],(function(e,i,t,a,s,r){"use strict";var o={cs:{},de:{"An error occurred":"Ein Fehler ist aufgetreten","Couldn't save. Error when contacting the server":"Speicher nicht möglich. Fehler beim Kontaktieren des Servers","Diagram imported":"Diagramm importiert","Draw.io document":"Draw.io-Datei","Draw.io editor":"Draw.io Editor","File saved!":"Datei gespeichert!","Loading media":"Lade Daten","Saving error. You're not authorized to save this file":"Speicherfehler. Keine ausreichenden Berechtigungen, um die Datei zu speichern","The diagram was successfully saved":"Das Diagram wurde erfolgreich gespeichert","The diagram will open as a new .drawio file: %{file}":"Das Diagramm wird als neue .drawio Datei geöffnet: %{file}","This file was updated outside this window. Please refresh the page. All changes will be lost, so download a copy first.":"Die Datei wurde außerhalb dieses Fensters aktualisiert. Bitte lade die Seite neu. Alle Änderungen gehen dabei verloren, bitte lade erst eine Kopie herunter."},es:{"Diagram imported":"Diagrama importado","Draw.io editor":"Editor Draw.io","Loading media":"Cargando medios"},fr:{"An error occurred":"Une erreur est survenue","Couldn't save. Error when contacting the server":"Enregistrement impossible. Erreur de communication avec le serveur","Diagram imported":"Diagramme importé","Draw.io document":"Document Draw.io","Draw.io editor":"Éditeur Draw.io","File saved!":"Fichier enregistré !","Loading media":"Chargement du media","Saving error. You're not authorized to save this file":"Erreur d'enregistrement. Vous n'êtes pas autorisé à enregistrer ce fichier","The diagram was successfully saved":"Le diagramme a bien été enregistré","The diagram will open as a new .drawio file: %{file}":"Le diagramme va s'ouvrir comme un nouveau fichier .drawio : %{file}","This file was updated outside this window. Please refresh the page. All changes will be lost, so download a copy first.":"Ce fichier a été modifié en dehors de cette fenêtre. Veuillez rafraîchir la page. Tous les changements seront perdus, téléchargez-en une copie avant."},gl:{},it:{"Diagram imported":"Diagramma importato","Draw.io document":"Documento Draw.io","Draw.io editor":"Editor Draw.io","File saved!":"File salvato!","Loading media":"Caricamento media","Saving error. You're not authorized to save this file":"Errore di salvataggio. L'utente non è autorizzato a salvare questo file","The diagram will open as a new .drawio file: %{file}":"Il diagramma verrà aperto come nuovo file .drawio: %{file}"}};const n={name:"DrawIoEditor",setup:()=>({...t.useAppDefaults({applicationId:"draw-io"})}),data:()=>({loading:!0,filePath:"",fileExtension:"",isReadOnly:null,currentETag:null}),computed:{config(){const{url:e="https://embed.diagrams.net",theme:i="minimal",autosave:t=!1}=this.applicationConfig;return{url:e,theme:i,autosave:t?1:0}},iframeSource(){const i=e.lib.stringify({embed:1,chrome:this.isReadOnly?0:1,picker:0,stealth:1,spin:1,proto:"json",ui:this.config.theme});return`${this.config.url}?${i}`}},created(){this.filePath=this.currentFileContext.path,this.fileExtension=this.filePath.split(".").pop(),this.checkPermissions(),window.addEventListener("message",(e=>{if(e.data.length>0){const i=JSON.parse(e.data);switch(i.event){case"init":"vsdx"===this.fileExtension?this.importVisio():this.load();break;case"autosave":this.save(i,!0);break;case"save":this.save(i);break;case"exit":this.exit()}}}))},methods:{...e.mapActions(["showMessage"]),errorPopup(e){this.showMessage({title:this.$gettext("An error occurred"),desc:e,status:"danger"})},successPopup(e){this.showMessage({title:this.$gettext("The diagram was successfully saved"),desc:e,status:"success"})},errorNotification(e){this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"status",message:e,modified:!1}),"*")},checkPermissions(){this.getFileInfo(this.filePath,[i.DavProperty.Permissions]).then((e=>{this.isReadOnly=-1===e.fileInfo[i.DavProperty.Permissions].indexOf(i.DavPermission.Updateable),this.loading=!1})).catch((e=>{this.errorPopup(e)}))},load(){this.getFileContents(this.filePath).then((e=>{this.currentETag=e.headers.ETag,this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"load",xml:e.body,autosave:this.config.autosave}),"*")})).catch((e=>{this.errorPopup(e)}))},importVisio(){const i=this.getFileUrl(this.filePath);this.filePath+=`_${this.getTimestamp()}.drawio`,this.showMessage({title:this.$gettext("Diagram imported"),desc:(()=>this.$gettextInterpolate(this.$gettext("The diagram will open as a new .drawio file: %{file}"),{file:e.basename(this.filePath)},!0))()}),this.makeRequest("GET",i).then((e=>e.arrayBuffer())).then((e=>{const i=new Blob([e],{type:"application/vnd.visio"}),t=new FileReader;t.onloadend=()=>{this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"load",xml:t.result,autosave:this.config.autosave}),"*")},t.readAsDataURL(i)})).catch((e=>{this.errorPopup(e)}))},save(e,i=!1){this.putFileContents(this.filePath,e.xml,{previousEntityTag:this.currentETag}).then((e=>{this.currentETag=e.ETag;const t=this.$gettext("File saved!");i?this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"status",message:t,modified:!1}),"*"):this.successPopup(t)})).catch((e=>{const t=i?this.errorNotification:this.errorPopup;switch(e.statusCode){case 412:t(this.$gettext("This file was updated outside this window. Please refresh the page. All changes will be lost, so download a copy first."));break;case 500:t(this.$gettext("Couldn't save. Error when contacting the server"));break;case 401:t(this.$gettext("Saving error. You're not authorized to save this file"));break;default:t(e.message||e)}}))},exit(){window.close()},getTimestamp:()=>e.DateTime_1.local().toFormat("YYYYMMDD[T]HHmmss")}};var d=function(){var e=this,i=e.$createElement,t=e._self._c||i;return t("main",[e.loading?t("div",{staticClass:"oc-position-center"},[t("oc-spinner",{attrs:{size:"xlarge"}}),e._v(" "),t("p",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-invisible"},[e._v("Loading media")])],1):t("iframe",{ref:"drawIoEditor",attrs:{id:"drawio-editor",src:e.iframeSource,title:e.$gettext("Draw.io editor")}})])};d._withStripped=!0;return{appInfo:{name:"Draw.io",id:"draw-io",icon:"grid",extensions:[{extension:"drawio",newTab:!0,routeName:"draw-io",newFileMenu:{menuTitle:e=>e("Draw.io document")}},{extension:"vsdx",newTab:!0,routeName:"draw-io"}]},routes:[{name:"draw-io",path:"/:filePath*",component:e.normalizeComponent({render:d,staticRenderFns:[]},undefined,n,"data-v-bf7bc3e4",false,undefined,!1,void 0,void 0,void 0),meta:{auth:!1,patchCleanPath:!0}}],translations:o}}));
